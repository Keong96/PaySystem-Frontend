<!DOCTYPE html>
<html>
<head>
  <title>支付系统</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

</head>
<body>
    <div class="container mt-5">
        <div id="dashboard_header">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">主页</button>
                    <button class="nav-item nav-link" id="nav-request-tab" data-toggle="tab" href="#nav-deposit-request" role="tab" aria-controls="nav-request" aria-selected="false">汇款列表</button>
                    <button class="nav-item nav-link" id="nav-request-tab" data-toggle="tab" href="#nav-withdraw-request" role="tab" aria-controls="nav-request" aria-selected="false">提现列表</button>
                    <button class="nav-item nav-link" id="nav-action-log-tab" data-toggle="tab" href="#nav-action-log" role="tab" aria-controls="nav-action-log" aria-selected="false">操作日志</button>
                    <button class="nav-item nav-link" id="nav-alert-msg-tab" data-toggle="tab" href="#nav-alert-msg" role="tab" aria-controls="nav-alert-msg" aria-selected="false">警报系统</button>
                    <button class="nav-item nav-link" id="nav-setting-tab" data-toggle="tab" href="#nav-setting" role="tab" aria-controls="nav-setting" aria-selected="false">设置</button>
                </div>
            </nav>
        </div>
        <div id="dashboard_content">
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab"></div>
                <div class="tab-pane fade" id="nav-deposit-request" role="tabpanel" aria-labelledby="nav-request-tab"></div>
                <div class="tab-pane fade" id="nav-withdraw-request" role="tabpanel" aria-labelledby="nav-request-tab"></div>
                <div class="tab-pane fade" id="nav-action-log" role="tabpanel" aria-labelledby="nav-action-log-tab"></div>
                <div class="tab-pane fade" id="nav-alert-msg" role="tabpanel" aria-labelledby="nav-alert-msg-tab"></div>
                <div class="tab-pane fade" id="nav-setting" role="tabpanel" aria-labelledby="nav-setting-tab"></div>
            </div>
        </div>
</body>

<div id="error-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <p id="error-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="hideModal()">Okay</button>
            </div>
        </div>
    </div>
</div>

<script>
    
    const errorModal = document.getElementById('error-modal');
    const errorModalMessage = document.getElementById('error-modal-message');
    const token = localStorage.getItem('token');
    
    //#region Function
    function hideModal() 
    {
        errorModal.style.display = 'none';
    }

    function showErrorModal(message) {
        errorModalMessage.innerHTML = message;
        errorModal.style.display = 'block';
    }

    function getHome()
    {
        axios.get("https://paysystem.onrender.com/request/latest/", {
            headers: { Authorization: `Bearer ${token}` }
        })
        .then(response => {

            var content = '<br><table class="table table-striped">';
            content += '<thead><tr><th scope="col">订单号</th><th scope="col">类型</th><th scope="col">发款地址</th><th scope="col">收款地址</th><th scope="col">数额</th><th scope="col">时间</th><th scope="col">状态</th><th colspan="2" scope="col" style="text-align:center">操作</th></tr></thead>';
            for(i = 0; i < response.data.length; i++)
            {
                content += "<tr>";
                content += "<td>"+response.data[i]['id']+"</td>";
                
                if(response.data[i]['request_type'] == 0)
                {
                    content += "<td style='color:green'>汇款</td>";
                }
                else
                {
                    content += "<td style='color:red'>提现</td>";
                }

                content += "<td>"+response.data[i]['sender_address']+"</td>";
                content += "<td>"+response.data[i]['receiver_address']+"</td>";
                content += "<td>"+response.data[i]['amount']+"</td>";
                content += "<td>"+response.data[i]['datetime']+"</td>";

                var status = response.data[i]['status'];
                switch(status)
                {
                case 0:
                    content += "<td style='color:blue;'>未结算</td>";
                    break;
                case 1:
                    content += "<td style='color:red;'>已取消</td>";
                    break;
                case 2:
                    content += "<td style='color:green;'>已结算</td>";
                    break;
                }
                content += "</tr>";
            }
            content += "</table><br><br>";

            axios.get("https://paysystem.onrender.com/home/get", {
                headers: { Authorization: `Bearer ${token}` }
            })
            .then(response2 => {

                content += '<br><table class="table table-striped">';
                content += '<thead><tr><th scope="col">钱包地址</th><th scope="col">今日收入</th><th scope="col">今日支出</th></tr></thead>';
                for(i = 0; i < response2.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+response2.data[i]['walletAddress']+"</td>";
                    content += "<td>"+response2.data[i]['today_in']+"</td>";
                    content += "<td>"+response2.data[i]['today_out']+"</td>";
                    content += "</tr>";
                }
                content += "</table>";

                document.getElementById('nav-home').innerHTML = content;
            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
        })
        .catch(error => {
            showErrorModal(error.response);
            console.log(error);
        });
    }

    function getDepositRequest()
    {
        axios.get("https://paysystem.onrender.com/request/get/0", {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(response => {

                var content = '<br><table class="table">';
                
                content += '<thead><tr><th scope="col">订单号</th><th scope="col">发款地址</th><th scope="col">收款地址</th><th scope="col">数额</th><th scope="col">时间</th><th scope="col">状态</th><th colspan="2" scope="col" style="text-align:center">操作</th></tr></thead>';
                for(i = 0; i < response.data.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";

                    content += "<td>"+response.data.data[i]['sender_address']+"</td>";
                    content += "<td>"+response.data.data[i]['receiver_address']+"</td>";
                    content += "<td>"+response.data.data[i]['amount']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";

                    var status = response.data.data[i]['status'];
                    switch(status)
                    {
                    case 0:
                        content += "<td style='color:blue;'>未结算</td>";
                        break;
                    case 1:
                        content += "<td style='color:red;'>已取消</td>";
                        break;
                    case 2:
                        content += "<td style='color:green;'>已结算</td>";
                        break;
                    }
                    content += "<td>";
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += "</td></tr>";
                }
                content += "</table>";

                content += '<nav aria-label="Page navigation example">';
                content += '<ul class="pagination justify-content-end">'
                
                // switch(response.data.currentPage)
                // {
                // case 1:
                //     content += '<li class="page-item disabled"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+response.data.currentPage+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage+1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage+2)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // case response.data.totalPages:
                //     content += '<li class="page-item"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage-2)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage-1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // default:
                //     content += '<li class="page-item"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage-1)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+response.data.currentPage+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage+1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // }

                content += '</ul>'
                content += '</nav>'

            document.getElementById('nav-deposit-request').innerHTML = content;

            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }

    function getWithdrawRequest()
    {
        axios.get("https://paysystem.onrender.com/request/get/1", {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(response => {

                var content = '<br><table class="table">';
                
                content += '<thead><tr><th scope="col">订单号</th><th scope="col">发款地址</th><th scope="col">收款地址</th><th scope="col">数额</th><th scope="col">时间</th><th scope="col">状态</th><th colspan="2" scope="col" style="text-align:center">操作</th></tr></thead>';
                for(i = 0; i < response.data.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";

                    content += "<td>"+response.data.data[i]['sender_address']+"</td>";
                    content += "<td>"+response.data.data[i]['receiver_address']+"</td>";
                    content += "<td>"+response.data.data[i]['amount']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";

                    var status = response.data.data[i]['status'];
                    switch(status)
                    {
                    case 0:
                        content += "<td style='color:blue;'>未结算</td>";
                        break;
                    case 1:
                        content += "<td style='color:red;'>已取消</td>";
                        break;
                    case 2:
                        content += "<td style='color:green;'>已结算</td>";
                        break;
                    }
                    content += "<td>";
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    content += "</td></tr>";
                }
                content += "</table>";

                content += '<nav aria-label="Page navigation example">';
                content += '<ul class="pagination justify-content-end">'
                
                // switch(response.data.currentPage)
                // {
                // case 1:
                //     content += '<li class="page-item disabled"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+response.data.currentPage+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage+1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage+2)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // case response.data.totalPages:
                //     content += '<li class="page-item"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage-2)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage-1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // default:
                //     content += '<li class="page-item"><a class="page-link" href="#" tabindex="-1"> <- </a></li>';
                //     content += '<li class="page-item"><a class="page-link" href="#"> '+(response.data.currentPage-1)+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+response.data.currentPage+' </a></li>'
                //     content += '<li class="page-item disabled"><a class="page-link" href="#"> '+(response.data.currentPage+1)+' </a></li>'
                //     content += '<li class="page-item"><a class="page-link" href="#"> -> </a></li>';
                //     break;
                // }

                content += '</ul>'
                content += '</nav>'

            document.getElementById('nav-withdraw-request').innerHTML = content;

            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }

    function getActionLog()
    {
        //action_log
        axios.get("https://paysystem.onrender.com/action_log/get", {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(response => {
            
            var content = '<br><table class="table table-striped">';
            content += '<thead><tr><th scope="col">ID</th><th scope="col">用户</th><th scope="col">操作内容</th><th scope="col">时间</th></tr></thead>';
            for(i = 0; i < response.data.data.length; i++)
            {
                axios.get("https://paysystem.onrender.com/user/get/"+response.data.data[i]['user_id'], {
                    headers: { Authorization: `Bearer ${token}` }
                })
                .then(response2 => {
                    var username = response2.data[0]['username'];

                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";
                    content += "<td>"+username+"</td>";
                    content += "<td>"+response.data.data[i]['action']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";
                    content += "</tr>";
                })
                .catch(error => {
                    showErrorModal(error.response);
                    console.log(error);
                });
            }

            document.getElementById('nav-action-log').innerHTML = content;
          })
          .catch(error => {
              showErrorModal(error.response);
              console.log(error);
          });
    }

    function getAlarm()
    {

    }

    function getSetting()
    {
        //setting
        axios.get("https://paysystem.onrender.com/setting/get", {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(response => {
            
            var content = '<br><form><div class="form-group row">';
            content += '<label class="col-sm-2 col-form-label">收款钱包地址</label><div class="col-sm-10">'
            
            content += '<input type="text" class="form-control" value="'+response.data[0].setting_value+'" id="wallet_address_1">'
            content += '<input type="text" class="form-control" value="'+response.data[1].setting_value+'" id="wallet_address_2">'
            content += '<input type="text" class="form-control" value="'+response.data[2].setting_value+'" id="wallet_address_3">'
            content += '<input type="text" class="form-control" value="'+response.data[3].setting_value+'" id="wallet_address_4">'
            content += '<input type="text" class="form-control" value="'+response.data[4].setting_value+'" id="wallet_address_5">'

            content += '</div></div></form>';

            content += '<form><div class="form-group row">';
            content += '<label class="col-sm-2 col-form-label">自动转账额度</label><div class="col-sm-10">'
            content += '<input type="text" class="form-control" value="'+response.data[5].setting_value+'" id="auto_transfer_amount">'
            content += '</div></div></form>';

            document.getElementById('nav-setting').innerHTML = content;
          })
          .catch(error => {
              showErrorModal(error.response);
              console.log(error);
          });
    }
    //#endregion

    getHome();
    getDepositRequest();
    getWithdrawRequest();
    getActionLog();
    getAlarm();
    getSetting();

</script>
</html>