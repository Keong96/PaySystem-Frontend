<!DOCTYPE html>
<html>
<head>
  <title>支付系统</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

</head>
<body>
    <div class="container">
        <div id="dashboard_header">
            <nav>
                <span id="timer"></span>
                <br><br>
                <span id="username"></span>
                <br><br>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-item nav-link active" id="nav-request-tab" data-toggle="tab" href="#nav-deposit-request" role="tab" aria-controls="nav-request" aria-selected="false">收款列表</button>
                    <button class="nav-item nav-link" id="nav-request-tab" data-toggle="tab" href="#nav-withdraw-request" role="tab" aria-controls="nav-request" aria-selected="false">提现列表</button>
                    <button class="nav-item nav-link" id="nav-change-log-tab" data-toggle="tab" href="#nav-change-log" role="tab" aria-controls="nav-change-log" aria-selected="false">账变记录</button>
                    <button class="nav-item nav-link" id="nav-action-log-tab" data-toggle="tab" href="#nav-action-log" role="tab" aria-controls="nav-action-log" aria-selected="false">操作日志</button>
                    <button class="nav-item nav-link" id="nav-alert-msg-tab" data-toggle="tab" href="#nav-alert-msg" role="tab" aria-controls="nav-alert-msg" aria-selected="false">警报系统</button>
                    <button class="nav-item nav-link" id="nav-setting-tab" data-toggle="tab" href="#nav-setting" role="tab" aria-controls="nav-setting" aria-selected="false">设置</button>
                </div>
            </nav>
        </div>
        <div id="dashboard_content">
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade active show" id="nav-deposit-request" role="tabpanel" aria-labelledby="nav-deposit-tab"></div>
                <div class="tab-pane fade" id="nav-withdraw-request" role="tabpanel" aria-labelledby="nav-withdraw-tab"></div>
                <div class="tab-pane fade" id="nav-change-log" role="tabpanel" aria-labelledby="nav-change-log-tab"></div>
                <div class="tab-pane fade" id="nav-action-log" role="tabpanel" aria-labelledby="nav-action-log-tab"></div>
                <div class="tab-pane fade" id="nav-alert-msg" role="tabpanel" aria-labelledby="nav-alert-msg-tab"></div>
                <div class="tab-pane fade" id="nav-setting" role="tabpanel" aria-labelledby="nav-setting-tab"></div>
            </div>
            <div id="paginator"></div>
        </div>
    </div>
</body>

<div id="error-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <p id="error-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="hideModal()">Okay</button>
            </div>
        </div>
    </div>
</div>

<div id="qr-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <p id="qr-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="hideModal()">Okay</button>
            </div>
        </div>
    </div>
</div>

<style>
    table {
        text-align: center;
    }

    #timer {
       font-size: 18px; 
    }

    td {
        white-space: normal !important; 
        word-wrap: break-word;  
        text-align: center;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(238, 255, 0, 0.363);
    }

    .input-group {
      padding: 15px;
    }

    .input-group input{
        text-align: center;
    }

</style>

<script>
    
    const errorModal = document.getElementById('error-modal');
    const errorModalMessage = document.getElementById('error-modal-message');
    const QRModal = document.getElementById('qr-modal');
    const QRModalMessage = document.getElementById('qr-modal-message');
    const token = localStorage.getItem('token');

    if (!token)
    {
        window.stop();
        window.location.href = 'login.html';
    }
    else
    {
        if(token.verified == 0)
        {
            window.stop();
            window.location.href = 'verification.html';
        }
        else
        {
            var decoded_token = jwt_decode(token);
            if (decoded_token.exp < Math.floor(Date.now()/1000))
            {
                window.stop();
                localStorage.removeItem("token");
                window.location.href = 'login.html';
            }
            document.getElementById("username").innerHTML = decoded_token.username;
        }
    }

    //#region Function
    function hideModal() 
    {
        errorModal.style.display = 'none';
        QRModal.style.display = 'none';
    }

    function showErrorModal(message) {
        errorModalMessage.innerHTML = message;
        errorModal.style.display = 'block';
    }

    function showQRModal(url) {
        const img = document.createElement("img");
        img.src = url;

        QRModalMessage.appendChild(img);
        QRModal.style.display = 'block';
    }

    function getDepositRequest(page, orderId=null, sender=null, receiver=null, startTime=null, endTime=null, amount=null)
    {
        var url = "https://paysystem.onrender.com/request/get?type=0";

        if(orderId)
            url += "&orderId="+orderId;
        if(sender)
            url += "&sender="+sender;
        if(receiver)
            url += "&receiver="+receiver;
        if(amount)
            url += "&amount="+amount;

        axios.get(url, {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(response => {
                
                var content = `<div class="input-group">`;
                content += `<input type="text" id="deposit_id" class="form-control" placeholder="订单号">`;
                content += `<input type="text" id="deposit_sender" class="form-control" placeholder="发款地址">`;
                content += `<input type="text" id="deposit_receiver" class="form-control" placeholder="收款地址">`;
                content += `<input type="text" id="deposit_time" class="form-control" placeholder="时间">`;
                content += `<input type="text" id="deposit_amount" class="form-control" placeholder="数额">`;
                content += `<button class="btn btn-outline-success my-2 my-sm-0" onclick="Search('deposit')">搜索</button>`;
                content += `</div>`;

                content += '<table class="table table-bordered align-middle table-hover">';
                
                content += '<thead><tr><th scope="col">订单号</th><th scope="col">发款地址</th><th scope="col">收款地址</th><th scope="col">时间</th><th scope="col">数额 (USDT) </th></thead>';
                for(i = 0; i < response.data.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";
                    content += "<td>"+response.data.data[i]['sender_address']+"</td>";
                    content += "<td>"+response.data.data[i]['receiver_address']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";
                    content += "<td>"+response.data.data[i]['amount']+"</td>";

                    // var status = response.data.data[i]['status'];
                    // switch(status)
                    // {
                    // case 0:
                    //     content += "<td style='color:blue;'>未结算</td>";
                    //     break;
                    // case 1:
                    //     content += "<td style='color:red;'>已取消</td>";
                    //     break;
                    // case 2:
                    //     content += "<td style='color:green;'>已结算</td>";
                    //     break;
                    // }
                    content += "</tr>";
                }
                content += "<tr style='background-color:#b7b7b7'><td colspan='4'><b>总额</b></td><td colspan='1'>"+response.data.total+"</td></tr>";
                content += "</table>";

                SetupPaginator(0, response.data.currentPage, response.data.totalPages, response.data.totalItems);

            document.getElementById('nav-deposit-request').innerHTML = content;

            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }

    function getWithdrawRequest(page, orderId=null, sender=null, receiver=null, startTime=null, endTime=null, amount=null)
    {
        var url = "https://paysystem.onrender.com/request/get?type=1";

        if(orderId)
            url += "&orderId="+orderId;
        if(sender)
            url += "&sender="+sender;
        if(receiver)
            url += "&receiver="+receiver;
        if(amount)
            url += "&amount="+amount;

        axios.get(url, {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(response => {

                var content = '<br><table class="table table-bordered align-middle table-hover">';
                
                content += '<thead><tr><th scope="col">订单号</th><th scope="col">发款地址</th><th scope="col">收款地址</th><th scope="col">时间</th><th scope="col">数额 (USDT) </th></tr></thead>';
                for(i = 0; i < response.data.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";

                    content += "<td>"+response.data.data[i]['sender_address']+"</td>";
                    content += "<td>"+response.data.data[i]['receiver_address']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";
                    content += "<td>"+response.data.data[i]['amount']+"</td>";

                    // var status = response.data.data[i]['status'];
                    // switch(status)
                    // {
                    // case 0:
                    //     content += "<td style='color:blue;'>未结算</td>";
                    //     break;
                    // case 1:
                    //     content += "<td style='color:red;'>已取消</td>";
                    //     break;
                    // case 2:
                    //     content += "<td style='color:green;'>已结算</td>";
                    //     break;
                    // }
                    // content += "<td>";
                    // content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    // content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    // content += '<button class="btn btn-outline-secondary" onclick=""><i class="fa fa-gear"></i></button> &nbsp';
                    // content += "</td></tr>";
                    content += "</tr>";
                }
                content += "<tr style='background-color:#b7b7b7'><td colspan='4'><b>总额</b></td><td colspan='1'>"+response.data.total+"</td></tr>";
                content += "</table>";

                SetupPaginator(1, response.data.currentPage, response.data.totalPages, response.data.totalItems);

            document.getElementById('nav-withdraw-request').innerHTML = content;

            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }

    function getChangeLog(page)
    {
        axios.get("https://paysystem.onrender.com/changelog/get/"+page, {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(response => {

                var content = '<br><table class="table table-bordered align-middle table-hover">';
                content += '<thead><tr><th scope="col">#</th><th scope="col">订单号</th><th scope="col">钱包地址</th><th scope="col">游戏ID</th><th scope="col">时间</th><th scope="col">更变前数额</th><th scope="col">数额</th><th scope="col">更变后数额</th></tr></thead>';
                for(i = 0; i < response.data.data.length; i++)
                {
                    content += "<tr>";
                    content += "<td>"+(i+1)+"</td>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";
                    content += "<td>"+response.data.data[i]['address']+"</td>";
                    content += "<td>"+response.data.data[i]['uid']+"</td>";

                    content += "<td style>"+response.data.data[i]['before']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";

                    switch(response.data.data[i]['request_type'])
                    {
                    case 0:
                        content += "<td style='color:green;'> + "+response.data.data[i]['amount']+"</td>";
                        break;
                    case 1:
                        content += "<td style='color:red;'> - "+response.data.data[i]['amount']+"</td>";
                        break;
                    }

                    content += "<td>"+response.data.data[i]['after']+"</td>";
                    content += "<td>"+response.data.data[i]['uid']+"</td>";

                    content += "</td></tr>";
                }
                content += "</table>";

                SetupPaginator(2, response.data.currentPage, response.data.totalPages, response.data.totalItems);

            document.getElementById('nav-change-log').innerHTML = content;

            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }
    
    function getActionLog(page)
    {
        //action_log
        axios.get("https://paysystem.onrender.com/action_log/get/"+page, {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(response => {
            
            var content = '<br><table class="table table-bordered align-middle">';
            content += '<thead><tr><th scope="col">ID</th><th scope="col">用户</th><th scope="col">操作内容</th><th scope="col">时间</th></tr></thead>';
            for(i = 0; i < response.data.data.length; i++)
            {
                axios.get("https://paysystem.onrender.com/user/get/"+response.data.data[i]['user_id'], {
                    headers: { Authorization: `Bearer ${token}` }
                })
                .then(response2 => {
                    var username = response2.data[0]['username'];

                    content += "<tr>";
                    content += "<td>"+response.data.data[i]['id']+"</td>";
                    content += "<td>"+username+"</td>";
                    content += "<td>"+response.data.data[i]['action']+"</td>";
                    content += "<td>"+response.data.data[i]['datetime']+"</td>";
                    content += "</tr>";
                })
                .catch(error => {
                    showErrorModal(error.response);
                    console.log(error);
                });
            }
            content += "</table>";
            
            SetupPaginator(3, response.data.currentPage, response.data.totalPages, response.data.totalItems);

            document.getElementById('nav-action-log').innerHTML = content;
          })
          .catch(error => {
              showErrorModal(error.response);
              console.log(error);
          });
    }

    function getAlarm(page)
    {

    }

    function getSetting(page)
    {
        //setting
        axios.get("https://paysystem.onrender.com/setting/get/"+page, {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(response => {
            
            var content = '<br><form><div class="form-group row">';
            
            document.getElementById('nav-setting').innerHTML = content;
          })
          .catch(error => {
              showErrorModal(error.response);
              console.log(error);
          });
    }

    function RandomQR()
    {
        axios.get("https://paysystem.onrender.com/setting/get", {
            headers: { Authorization: `Bearer ${token}` }
            })
            .then(response => {
                var rand = Math.floor(Math.random() * 5);

                qrcode.toDataURL(response.data[rand].setting_value, function (err, url) {
                    if(err)
                    console.log("error: = "+err);

                    showQRModal(url);
                })
            })
            .catch(error => {
                showErrorModal(error.response);
                console.log(error);
            });
    }

    function Timer()
    {
        const currentTime = new Date();

        const day = currentTime.getDate();
        const month = currentTime.getMonth() + 1;
        const year = currentTime.getFullYear();

        const hours = currentTime.getHours();
        const minutes = currentTime.getMinutes();
        const seconds = currentTime.getSeconds();

        const formattedTime = `${year}年${month}月${day}日, ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById("timer").innerHTML = "当前时间 ："+formattedTime;
    }

    function SetupPaginator(type, currentPage, totalPages, totalItems)
    {
        const paginator = document.getElementById('paginator');
        paginator.innerHTML = '';

        const recordText = document.createElement('span');
        recordText.innerHTML = totalItems+" 条记录 &nbsp &nbsp";
        paginator.appendChild(recordText);

        const firstPageButton = document.createElement('button');
        firstPageButton.classList.add("btn");
        firstPageButton.classList.add("btn-outline-secondary");
        firstPageButton.textContent = "首页";
        if(currentPage == 1)
        {
            firstPageButton.classList.add("active");
            firstPageButton.classList.add("disabled");
        }
        paginator.appendChild(firstPageButton);

        for (let i = 1; i <= totalPages; i++)
        {
            const button = document.createElement('button');
            
            button.classList.add("btn");
            button.textContent = i;

            if(i == currentPage)
            {
                button.classList.add("btn-outline-secondary");
                button.classList.add("active");
                button.classList.add("disabled");
            }
            else
            {
                button.classList.add("btn-outline-secondary");
            }

            button.addEventListener('click', () => {
                switch(type)
                {
                    case 0: getDepositRequest(i);
                        break;
                    case 1: getWithdrawRequest(i);
                        break;
                    case 2: getChangeLog(i);
                        break;
                    case 3: getActionLog(i);
                        break;
                    case 4: getAlarm(i);
                        break;
                    case 5: getSetting(i);
                        break;
                }
            });

            paginator.appendChild(button);
        }

        const lastPageButton = document.createElement('button');
        lastPageButton.classList.add("btn");
        lastPageButton.classList.add("btn-outline-secondary");
        lastPageButton.textContent = "尾页";
        if(currentPage == totalPages)
        {
            lastPageButton.classList.add("active");
            lastPageButton.classList.add("disabled");
        }
        paginator.appendChild(lastPageButton);
    }

    function Search(type)
    {
        var url = "";

        switch(type)
        {
            case "deposit":
                break;
        }

        
    }
    //#endregion

    getDepositRequest(1);
    getWithdrawRequest(1);
    // getChangeLog(1);
    // getActionLog(1);
    // getAlarm(1);
    // getSetting(1);
    setInterval(Timer, 1000);

</script>
</html>